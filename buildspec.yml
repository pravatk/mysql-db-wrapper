# This is the build specification for building node based lambda.
# First step in the process is to install all required modules for the lambda. The next step is to package the lambda to a zip file, post which we use cloudformation package to upload the zip to s3.
# We are using CloudFormation package command, which replaces the samTemplate.yaml file's CodeUri with the S3 url. The Output of the "cloudformation package" command would be the SAM template wuth replaced CodeUri.
# The output artifact of the build step includes the sam template and the json file including the CloudFormation template parameters.
version: 0.2
phases:
  install:
    commands:
      - echo Starting to install modules on  `date`
      - python --version
      - export HOME_DIR=$PWD
      - python --version
      # COMMON
      # Build common modules
      - cd $HOME_DIR/kms && npm install
      # Build Database utility library
      - cd $HOME_DIR/db_utils && npm install 
      # Build logger modules
      - cd $HOME_DIR/kdlogger && npm install
  build:
    commands:
      - echo Build started on `date`
      - cd $HOME_DIR/db_utils && npm run coverage && npm run report
  post_build:
    commands:
      - echo Build completed on `date`
      # Build coverage
      - cd $HOME_DIR/db_utils/coverage
      - zip -9rq coverage.zip .
      - cp coverage.zip $HOME_DIR
      - cd $HOME_DIR && sh $HOME_DIR/jira_update.sh
